#!/bin/bash
# Usage: steal <YOUTUBE-URL> [--upload]
#
# Steals a song from YouTube and adds to to iTunes.
#
# Requirements: youtube-dl, ffmpeg
set -e

# strip the YouTube playlist
url="${1%%&*}"

if [ -z "$url" ]; then
  echo "no URL given" >&2
  exit 1
fi

youtube-dl --no-mtime -xo '/tmp/%(title)s.%(ext)s' "$url"
shopt -s nullglob
file="$(ls -t /tmp/*.{m4a,mp3,mp4} | head -1)"

case "$file" in
*.m4a | *.mp4 )
  destfile="${file%.*}.mp3"
  ffmpeg -i "$file" -f mp3 -ab 192000 -vn "$destfile"
  rm "$file"
  file="$destfile"
  ;;
esac

case "$file" in
  *.opus)
    echo 'in case opus'
    echo "${file%.*}.mp3"
    destfile="${file%.*}.mp3"
    ffmpeg -i "$file" -acodec libmp3lame "$file".mp3
    rm "$file"
    file="$destfile"
    ;;
esac

case "$2" in
  -u|--upload|-g)
    echo "In case: upload"
    echo "Uploading $file"
    gmupload.py "$file"
    ;;
  *)
    # add to itunes by default
    mv -v "$file" \
      "${HOME}/Music/iTunes/iTunes Media/Automatically Add to iTunes"*
    ;;
esac

case $3 in
  *)
    mv -v "$file" \
      "${HOME}/Music/iTunes/iTunes Media/Automatically Add to iTunes"*
    ;;
esac
